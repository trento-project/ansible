# code: language=ansible
---
- name: Install rabbitmq
  community.general.zypper:
    name: rabbitmq-server
    state: present
    update_cache: true
  
- name: Ensure /etc/rabbitmq/ssl directory exists
  ansible.builtin.file:
    path: /etc/rabbitmq/ssl
    state: directory
    mode: '0700'

- name: Add certificate files
  ansible.builtin.copy:
    content: "{{ item.content }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode }}"
  with_items:
    - { dest: '/etc/rabbitmq/ssl/cert.pem', content: '{{ rabbitmq_ssl_cert }}', mode: '0644' }
    - { dest: '/etc/rabbitmq/ssl/key.pem', content: '{{ rabbitmq_ssl_key }}', mode: '0600' }
    - { dest: '/etc/rabbitmq/ssl/ca.pem', content: '{{ rabbitmq_ssl_ca_cert }}', mode: '0644' }

- name: Start rabbitmq service
  ansible.builtin.service:
    name: rabbitmq-server
    state: started
    enabled: true
  vars:
    rabbitmq_ssl_cert: /etc/rabbitmq/ssl/cert.pem
    rabbitmq_ssl_key: /etc/rabbitmq/ssl/key.pem
    rabbitmq_ssl_ca: /etc/rabbitmq/ssl/cacert.pem

- name: Create rabbitmq trento vhost
  community.rabbitmq.rabbitmq_vhost:
    name: "{{ rabbitmq_vhost }}"
    node: "{{ rabbitmq_node_name }}"
    state: present

- name: Configure rabbitmq trento user
  community.rabbitmq.rabbitmq_user:
    user: "{{ rabbitmq_username }}"
    node: "{{ rabbitmq_node_name }}"
    password: "{{ rabbitmq_password }}"
    permissions:
      - vhost: "{{ rabbitmq_vhost }}"
        configure_priv: ".*"
        read_priv: ".*"
        write_priv: ".*"
