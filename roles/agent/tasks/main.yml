# code: language=ansible
---
- name: Add Trento agent repository
  community.general.zypper_repository:
    name: trento
    repo: "{{ trento_repository }}"
    state: present
    auto_import_keys: true

- name: Install Trento agent
  community.general.zypper:
    name: trento-agent
    state: latest

- name: Ensure /etc/rabbitmq/ssl directory exists
  ansible.builtin.file:
    path: /etc/rabbitmq/ssl
    state: directory
    mode: '0700'

- name: Add certificate files
  ansible.builtin.copy:
    content: "{{ item.content | b64decode if item.base64 == 'true' else item.content }}"
    dest: "{{ item.dest }}"
    owner: root
    group: root
    mode: "0644"
  loop:
    - content: "{{ rabbitmq_ssl_cert }}"
      dest: "/etc/rabbitmq/ssl/cert.pem"
      base64: "{{ rabbitmq_ssl_cert_as_base64 }}"
    - content: "{{ rabbitmq_ssl_key }}"
      dest: "/etc/rabbitmq/ssl/key.pem"
      base64: "{{ rabbitmq_ssl_key_as_base64 }}"
    - content: "{{ rabbitmq_ssl_ca_cert }}"
      dest: "/etc/rabbitmq/ssl/ca.pem"
      base64: "{{ rabbitmq_ssl_ca_cert_as_base64 }}"
      
- name: Configure Trento agent
  ansible.builtin.template:
    src: "agent.conf.j2"
    dest: "/etc/trento/agent.yaml"
    mode: "0600"
  vars:
    server_url: "{{ trento_server_url }}"
    api_key: "{{ trento_api_key }}"
    facts_service_url: "{{ amqp_protocol }}://{{ rabbitmq_username }}:{{ rabbitmq_password }}@{{ rabbitmq_host }}/{{ rabbitmq_vhost | urlencode | replace('/', '%2F') }}?certfile=/etc/rabbitmq/ssl/cert.pem&keyfile=c/etc/rabbitmq/ssl/key.pem&verify=verify_peer&cacertfile=/etc/rabbitmq/ssl/ca.pem"
  notify:
    - Restart Trento agent

- name: Start Trento agent service
  ansible.builtin.service:
    name: trento-agent
    state: started
    enabled: true
